# Metaprogramming



---

**Resources:**

[元编程 · the missing semester of your cs education](https://missing-semester-cn.github.io/2020/metaprogramming/)







---



## 构建系统

对于大多数系统来说，不论其是否包含代码，都会包含一个 “构建过程”。有时，您需要执行一系列操作。通常，这一过程包含了很多步骤，很多分支。执行一些命令来生成图表，然后执行另外的一些命令生成结果，然后再执行其他的命令来生成最终的论文。有很多事情需要我们完成，您并不是第一个因此感到苦恼的人，幸运的是，有很多工具可以帮助我们完成这些操作。

这些工具通常被称为 “构建系统”，而且这些工具还不少。如何选择工具完全取决于您当前手头上要完成的任务以及项目的规模。从本质上讲，这些工具都是非常类似的。您需要定义 **依赖**、**目标** 和 **规则**。您必须告诉构建系统您具体的构建目标，系统的任务则是找到构建这些目标所需要的**依赖**，并根据规则构建所需的中间产物，直到最终**目标**被构建出来。理想的情况下，如果目标的依赖没有发生改动，并且我们可以从之前的构建中复用这些依赖，那么与其相关的构建规则并不会被执行。

`make` 是最常用的构建系统之一，您会发现它通常被安装到了几乎所有基于 UNIX 的系统中。`make` 并不完美，但是对于中小型项目来说，它已经足够好了。

**它的工作原理大致为：**

1. 读取 `Makefile`（或 `makefile`）里的规则与变量。

   ```makefile
   target: prereq1 prereq2 ...
   <TAB>recipe-line-1
   <TAB>recipe-line-2
   ```

2. 以用户指定的目标（默认是第一个 target）为根，递归构建依赖图（DAG）。

3. 对每个目标，`make` 比较目标文件与其依赖文件的时间戳：若目标缺失或比任一依赖旧，就运行该目标对应的 recipe（命令）来生成它。

4. 按依赖顺序执行命令；如果没有必要（都已最新），则什么也不做。

当您执行 `make` 时，它会去参考当前目录下名为 `Makefile` 的文件。所有构建目标、相关依赖和规则都需要在该文件中定义，一个真实的`makefile`看上去是这样的：

```makefile
paper.pdf: paper.tex plot-data.png
	pdflatex paper.tex

plot-%.png: %.dat plot.py
	./plot.py -i $*.dat -o $@
```

